<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telco Churn Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1/dist/tfjs-vis.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #005a87;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .input-group {
            margin: 10px 0;
        }
        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
        }
        input[type="number"], input[type="text"] {
            padding: 5px;
            width: 100px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        #log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .small {
            font-size: 12px;
            color: #666;
        }
        .metrics {
            background: #e8f4f8;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        .file-input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Telco Churn EDA + Neural Network + Business Simulator</h1>
        <p class="small">Client-only application using TensorFlow.js - No data leaves your browser</p>

        <!-- Data Loading Section -->
        <div class="section">
            <h3>üìÅ 1. Data Loading</h3>
            <div class="file-input">
                <label for="datasetFile">Upload dataset CSV:</label>
                <input type="file" id="datasetFile" accept=".csv" />
                <button id="btnLoad">Load Data</button>
            </div>
            <div class="small">
                Expected columns: customerID, gender, SeniorCitizen, Partner, Dependents, tenure, PhoneService, 
                MultipleLines, InternetService, OnlineSecurity, OnlineBackup, DeviceProtection, TechSupport, 
                StreamingTV, StreamingMovies, Contract, PaperlessBilling, PaymentMethod, MonthlyCharges, TotalCharges, Churn
            </div>
        </div>

        <!-- EDA Section -->
        <div class="section">
            <h3>üîç 2. Exploratory Data Analysis</h3>
            <button id="btnEDA">Run EDA</button>
        </div>

        <!-- Preprocessing Section -->
        <div class="section">
            <h3>‚öôÔ∏è 3. Preprocessing & Split</h3>
            <button id="btnPreprocess">Preprocess & Split Data</button>
        </div>

        <!-- Model Training Section -->
        <div class="section">
            <h3>ü§ñ 4. Model Training</h3>
            <div class="grid">
                <div>
                    <h4>Hyperparameters</h4>
                    <div class="input-group">
                        <label for="hpLayers">Layer Sizes:</label>
                        <input type="text" id="hpLayers" value="128,64" placeholder="e.g., 128,64">
                    </div>
                    <div class="input-group">
                        <label for="hpDropout">Dropout:</label>
                        <input type="number" id="hpDropout" value="0.2" step="0.1" min="0" max="0.9">
                    </div>
                    <div class="input-group">
                        <label for="hpL2">L2 Regularization:</label>
                        <input type="number" id="hpL2" value="0.001" step="0.001" min="0">
                    </div>
                    <div class="input-group">
                        <label for="hpLR">Learning Rate:</label>
                        <input type="number" id="hpLR" value="0.001" step="0.0001" min="0.0001">
                    </div>
                    <div class="input-group">
                        <label for="hpBatch">Batch Size:</label>
                        <input type="number" id="hpBatch" value="32" min="8" max="256">
                    </div>
                    <div class="input-group">
                        <label for="hpEpochs">Epochs:</label>
                        <input type="number" id="hpEpochs" value="100" min="10" max="500">
                    </div>
                    <div class="input-group">
                        <label for="hpSeed">Random Seed:</label>
                        <input type="number" id="hpSeed" value="42" min="0" max="999">
                    </div>
                </div>
                <div>
                    <h4>Training</h4>
                    <button id="btnTrainBaseline">Train Baseline (Logistic)</button>
                    <button id="btnTrainNN">Train Neural Network</button>
                </div>
            </div>
        </div>

        <!-- Evaluation Section -->
        <div class="section">
            <h3>üìà 5. Evaluation</h3>
            <div class="input-group">
                <label for="thresholdInput">Classification Threshold:</label>
                <input type="number" id="thresholdInput" value="0.5" step="0.01" min="0" max="1">
                <button id="btnSetF1">Set F1-optimal</button>
                <button id="btnSetYouden">Set Youden-optimal</button>
            </div>
            <div id="thresholdNotes" class="small"></div>
            <button id="btnEvaluate">Evaluate Models</button>
            <div id="metrics" class="metrics"></div>
        </div>

        <!-- Business Simulation Section -->
        <div class="section">
            <h3>üíº 6. Business Simulation</h3>
            <div class="grid">
                <div>
                    <div class="input-group">
                        <label for="bizOfferCost">Offer Cost ($):</label>
                        <input type="number" id="bizOfferCost" value="20.0" step="5">
                    </div>
                    <div class="input-group">
                        <label for="bizSaveRate">Save Rate:</label>
                        <input type="number" id="bizSaveRate" value="0.30" step="0.05" min="0" max="1">
                    </div>
                    <div class="input-group">
                        <label for="bizMonths">Retention Months:</label>
                        <input type="number" id="bizMonths" value="6" min="1" max="24">
                    </div>
                </div>
                <div>
                    <div class="input-group">
                        <label for="bizMargin">Profit Margin:</label>
                        <input type="number" id="bizMargin" value="0.4" step="0.05" min="0" max="1">
                    </div>
                    <div class="input-group">
                        <label for="bizKMin">Top-K Min %:</label>
                        <input type="number" id="bizKMin" value="5" min="1" max="49">
                    </div>
                    <div class="input-group">
                        <label for="bizKMax">Top-K Max %:</label>
                        <input type="number" id="bizKMax" value="40" min="2" max="50">
                    </div>
                </div>
            </div>
            <button id="btnBusiness">Run Business Simulation</button>
        </div>

        <!-- Model Management Section -->
        <div class="section">
            <h3>üíæ 7. Model Management</h3>
            <button id="btnSaveModel">Save Model to Browser</button>
            <button id="btnLoadModel">Load Model from Browser</button>
            <button id="btnDownloadModel">Download Model Files</button>
            <button id="btnDownloadPrep">Download Preprocessing Config</button>
            <div class="file-input">
                <label for="uploadConfig">Upload Preprocessing Config:</label>
                <input type="file" id="uploadConfig" accept=".json" />
            </div>
        </div>

        <!-- Manual Scoring Section -->
        <div class="section">
            <h3>üéØ 8. Manual Scoring</h3>
            <textarea id="manualRow" rows="6" cols="80" placeholder='Paste customer data as JSON, e.g.:
{
  "customerID": "1234-ABCD",
  "gender": "Male",
  "SeniorCitizen": 0,
  "Partner": "Yes",
  "Dependents": "No",
  "tenure": 12,
  "PhoneService": "Yes",
  "MultipleLines": "No",
  "InternetService": "DSL",
  "OnlineSecurity": "No",
  "OnlineBackup": "Yes",
  "DeviceProtection": "No",
  "TechSupport": "No",
  "StreamingTV": "No",
  "StreamingMovies": "No",
  "Contract": "Month-to-month",
  "PaperlessBilling": "Yes",
  "PaymentMethod": "Electronic check",
  "MonthlyCharges": 45.50,
  "TotalCharges": 546.00,
  "Churn": "No"
}'></textarea>
            <br>
            <button id="btnScoreRow">Score Customer</button>
            <div id="scoreOut" class="metrics"></div>
        </div>

        <!-- Log Section -->
        <div class="section">
            <h3>üìã Status / Log</h3>
            <div id="log">[1:42:18 PM] Ready. Start with Load Data.</div>
        </div>
    </div>

    <script>
        // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω –≤–µ—Å—å JavaScript –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª —Ä–∞–Ω–µ–µ
        // (–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã, STATE, —Ñ—É–Ω–∫—Ü–∏–∏ appendLog, mulberry32, parseTelcoCsv, loadDataFromFile –∏ —Ç.–¥.)
        
        // –í—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏–º –ø—Ä–æ—Å—Ç—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        const NUMERIC_FEATURES = ['tenure', 'MonthlyCharges', 'TotalCharges'];
        const CATEGORICAL_FEATURES = [
            'gender','SeniorCitizen','Partner','Dependents','PhoneService','MultipleLines',
            'InternetService','OnlineSecurity','OnlineBackup','DeviceProtection','TechSupport',
            'StreamingTV','StreamingMovies','Contract','PaperlessBilling','PaymentMethod'
        ];
        const TARGET_COL = 'Churn';
        const ID_COL = 'customerID';

        const STATE = {
            seed: 42,
            rawRows: [],
            cleanedRows: [],
            split: null,
            maps: null,
            transformed: null,
            models: { baseline: null, mlp: null },
            predictions: { baseline: {val: null, test: null}, mlp: {val: null, test: null} },
            thresholds: { manual: 0.5, f1: null, youden: null, selected: 'manual' },
            business: { offerCost: 20.0, saveRate: 0.30, retentionMonths: 6, margin: 0.4, kMin: 5, kMax: 40 },
            sampleWeights: null,
            trainingHistory: {},
        };

        function appendLog(msg) {
            const el = document.getElementById('log');
            const now = new Date().toLocaleTimeString();
            el.textContent += `[${now}] ${msg}\n`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        // Load data from user file - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
        async function loadDataFromFile() {
            const input = document.getElementById('datasetFile');
            const file = input.files && input.files[0];
            if (!file) {
                appendLog('Please choose a CSV file in the "Upload dataset CSV" field.');
                return [];
            }
            
            appendLog(`Reading file: ${file.name} (${Math.round(file.size/1024)} KB) ...`);
            
            try {
                const text = await readFileAsText(file);
                const rows = parseTelcoCsv(text);
                
                if (rows.length === 0) {
                    appendLog('Error: No data rows found in CSV file.');
                    return [];
                }
                
                STATE.rawRows = rows;
                appendLog(`Loaded ${rows.length} rows, ${Object.keys(rows[0]).length} columns from file.`);
                return rows;
            } catch (error) {
                appendLog(`Error loading file: ${error.message}`);
                return [];
            }
        }

        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('File reading failed'));
                reader.readAsText(file);
            });
        }

        function parseTelcoCsv(csvText) {
            try {
                const parsed = Papa.parse(csvText, { 
                    header: true, 
                    dynamicTyping: false, 
                    skipEmptyLines: true,
                    transform: (value) => value ? value.trim() : value
                });
                
                if (parsed.errors.length > 0) {
                    console.warn('CSV parsing warnings:', parsed.errors);
                    appendLog(`CSV parsing warnings: ${parsed.errors.map(e => e.message).join(', ')}`);
                }
                
                let rows = parsed.data.filter(row => Object.keys(row).length > 1);
                rows = rows.map(r => {
                    const o = {};
                    for (const k in r) o[k] = r[k] === '' ? null : r[k];
                    return o;
                });
                
                return rows;
            } catch (error) {
                console.error('CSV parsing error:', error);
                appendLog(`CSV parsing error: ${error.message}`);
                return [];
            }
        }

        // Basic button handlers for now
        document.getElementById('btnLoad').addEventListener('click', async () => {
            await loadDataFromFile();
            if (STATE.rawRows.length) appendLog('Done. Next: Run EDA or Preprocess & Split.');
        });

        document.getElementById('btnEDA').addEventListener('click', async () => {
            if (!STATE.rawRows.length) { 
                appendLog('Please upload CSV and click Load Data first.'); 
                return; 
            }
            appendLog('EDA functionality would run here...');
        });

        // Initialize
        appendLog('Ready. Upload your CSV and click "Load Data".');

    </script>
</body>
</html>
