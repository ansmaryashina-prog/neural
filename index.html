<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telco Churn Analyzer</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-vis@1.5.1/dist/tfjs-vis.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #fafafa;
        }
        .section h3 {
            margin-top: 0;
            color: #333;
        }
        button {
            background: #007cba;
            color: white;
            border: none;
            padding: 8px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #005a87;
        }
        #log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Telco Churn Analyzer</h1>

        <!-- Data Loading Section -->
        <div class="section">
            <h3>üìÅ 1. Data Loading</h3>
            <input type="file" id="datasetFile" accept=".csv" />
            <button id="btnLoad">Load Data</button>
        </div>

        <!-- EDA Section -->
        <div class="section">
            <h3>üîç 2. Exploratory Data Analysis</h3>
            <button id="btnEDA">Run EDA</button>
        </div>

        <!-- Log Section -->
        <div class="section">
            <h3>üìã Status / Log</h3>
            <div id="log">Ready. Start with Load Data.</div>
        </div>
    </div>

    <script>
        // Constants
        const NUMERIC_FEATURES = ['tenure', 'MonthlyCharges', 'TotalCharges'];
        const CATEGORICAL_FEATURES = [
            'gender', 'SeniorCitizen', 'Partner', 'Dependents', 'PhoneService', 'MultipleLines',
            'InternetService', 'OnlineSecurity', 'OnlineBackup', 'DeviceProtection', 'TechSupport',
            'StreamingTV', 'StreamingMovies', 'Contract', 'PaperlessBilling', 'PaymentMethod'
        ];
        const TARGET_COL = 'Churn';

        const STATE = {
            rawRows: [],
            cleanedRows: []
        };

        function appendLog(msg) {
            const el = document.getElementById('log');
            const now = new Date().toLocaleTimeString();
            el.textContent += `[${now}] ${msg}\n`;
            el.scrollTop = el.scrollHeight;
            console.log(msg);
        }

        // Helper function to read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('File reading failed'));
                reader.readAsText(file);
            });
        }

        function parseTelcoCsv(csvText) {
            try {
                const parsed = Papa.parse(csvText, { 
                    header: true, 
                    dynamicTyping: false, 
                    skipEmptyLines: true,
                    transform: (value) => value ? value.trim() : value
                });
                
                if (parsed.errors.length > 0) {
                    console.warn('CSV parsing warnings:', parsed.errors);
                }
                
                let rows = parsed.data.filter(row => Object.keys(row).length > 1);
                rows = rows.map(r => {
                    const o = {};
                    for (const k in r) o[k] = r[k] === '' ? null : r[k];
                    return o;
                });
                
                return rows;
            } catch (error) {
                console.error('CSV parsing error:', error);
                appendLog(`CSV parsing error: ${error.message}`);
                return [];
            }
        }

        // SIMPLIFIED Cleaning
        function imputeAndClean(rows) {
            appendLog('Cleaning data...');
            const cleaned = rows.map(r => ({ ...r }));
            
            for (const r of cleaned) {
                // Handle Churn column
                const churnVal = r[TARGET_COL];
                r._y = (churnVal === 'Yes' || churnVal === '1') ? 1 : 0;
                
                // Handle numeric columns
                r.tenure = Number(r.tenure) || 0;
                r.MonthlyCharges = Number(r.MonthlyCharges) || 0;
                r.TotalCharges = Number(r.TotalCharges) || 0;
                
                // Handle categorical columns
                for (const cat of CATEGORICAL_FEATURES) {
                    if (!r[cat] || r[cat] === '') r[cat] = 'Unknown';
                }
            }
            
            STATE.cleanedRows = cleaned;
            return cleaned;
        }

        // SIMPLIFIED EDA Function with proper data formats
        async function runEDA(rows) {
            if (!rows || rows.length === 0) {
                appendLog('ERROR: No data available for EDA');
                return;
            }
            
            appendLog('Starting EDA...');
            tfvis.visor().open();
            const tab = 'EDA';
            
            // Debug first row
            console.log('First row data:', rows[0]);
            appendLog(`Sample data - Churn: ${rows[0][TARGET_COL]}, _y: ${rows[0]._y}`);

            // 1. Churn Distribution ‚Äî PASS ARRAY DIRECTLY
            const churnYes = rows.filter(r => r._y === 1).length;
            const churnNo = rows.length - churnYes;
            
            const churnData = [
                { index: 'No Churn', value: churnNo },
                { index: 'Churn', value: churnYes }
            ];
            
            await tfvis.render.barchart(
                { name: '1. Churn Distribution', tab }, 
                churnData, 
                { 
                    xLabel: 'Churn Status', 
                    yLabel: 'Count',
                    height: 300 
                }
            );

            // 2. Numeric Features
            for (const numFeature of NUMERIC_FEATURES) {
                const values = rows.map(r => Number(r[numFeature]) || 0).filter(v => !isNaN(v));
                
                if (values.length > 0) {
                    await tfvis.render.histogram(
                        { name: `2. ${numFeature} Distribution`, tab }, 
                        values, 
                        { 
                            xLabel: numFeature, 
                            yLabel: 'Frequency', 
                            height: 300 
                        }
                    );
                }
            }

            // 3. Categorical Features ‚Äî Churn Rates ‚Äî PASS ARRAY DIRECTLY
            for (const catFeature of CATEGORICAL_FEATURES) {
                const categories = {};
                
                rows.forEach(row => {
                    const cat = row[catFeature] || 'Unknown';
                    if (!categories[cat]) {
                        categories[cat] = { total: 0, churn: 0 };
                    }
                    categories[cat].total++;
                    if (row._y === 1) {
                        categories[cat].churn++;
                    }
                });

                const chartData = Object.entries(categories).map(([category, data]) => ({
                    index: `${category} (${data.total})`,
                    value: (data.churn / data.total) * 100
                })).sort((a, b) => b.value - a.value);

                if (chartData.length > 0) {
                    await tfvis.render.barchart(
                        { name: `3. Churn Rate by ${catFeature}`, tab }, 
                        chartData, 
                        { 
                            xLabel: catFeature, 
                            yLabel: 'Churn Rate %', 
                            height: 400 
                        }
                    );
                }
            }

            // 4. Missing Values ‚Äî PASS ARRAY DIRECTLY
            const columns = Object.keys(rows[0]).filter(col => !col.startsWith('_'));
            const missingData = columns.map(col => {
                const missing = rows.filter(r => 
                    r[col] === null || r[col] === undefined || r[col] === ''
                ).length;
                return {
                    index: col,
                    value: (missing / rows.length) * 100
                };
            }).filter(item => item.value > 0);

            if (missingData.length > 0) {
                await tfvis.render.barchart(
                    { name: '4. Missing Values by Column (%)', tab }, 
                    missingData, 
                    { 
                        xLabel: 'Column', 
                        yLabel: 'Missing %', 
                        height: 400 
                    }
                );
            }

            appendLog(`EDA complete! Processed ${rows.length} rows. Overall churn rate: ${((churnYes/rows.length)*100).toFixed(1)}%`);
        }

        // Load data from user file
        async function loadDataFromFile() {
            const input = document.getElementById('datasetFile');
            const file = input.files && input.files[0];
            if (!file) {
                appendLog('Please choose a CSV file.');
                return [];
            }
            
            appendLog(`Reading file: ${file.name}...`);
            
            try {
                const text = await readFileAsText(file);
                const rows = parseTelcoCsv(text);
                
                if (rows.length === 0) {
                    appendLog('Error: No data rows found.');
                    return [];
                }
                
                STATE.rawRows = rows;
                appendLog(`‚úì Loaded ${rows.length} rows, ${Object.keys(rows[0]).length} columns`);
                appendLog(`Columns: ${Object.keys(rows[0]).join(', ')}`);
                
                return rows;
            } catch (error) {
                appendLog(`Error: ${error.message}`);
                return [];
            }
        }

        // Button handlers
        document.getElementById('btnLoad').addEventListener('click', async () => {
            await loadDataFromFile();
            if (STATE.rawRows.length) {
                appendLog('‚úì Data loaded. Click "Run EDA" to analyze.');
            }
        });

        document.getElementById('btnEDA').addEventListener('click', async () => {
            if (!STATE.rawRows.length) { 
                appendLog('Please load data first.'); 
                return; 
            }
            const cleaned = imputeAndClean(STATE.rawRows);
            await runEDA(cleaned);
        });

        // Initialize
        appendLog('Ready. Upload your CSV file and click "Load Data".');
    </script>
</body>
</html>
